<!DOCTYPE html>
<html>
  <head>
    <title>Coordinates boilerplate example</title>
    <style>
      body, html{
        background: #333;
        margin: 0;
        min-height: 100vh;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript" src="./zip.js"></script>
    
    <script type="module">
    
      import * as Coordinates from
      "https://srmcgann.github.io/Coordinates/coordinates.min.js"
    
      var rendererOptions = {
        margin: 0,
        ambientLight: .2,
        fov: 1500 / 2,
        width: 960,
        height: 540,
      }
      var renderer = await Coordinates.Renderer(rendererOptions)
      
      renderer.z = 32
      var S = Math.sin
      var C = Math.cos
      var Rn = Math.random
      
      //var refTexture = 'https://srmcgann.github.io/Coordinates/resources/rd3_po2_small.mp4'
      var refTexture = 'https://i.imgur.com/b1Lf8Rn.mp4'
      var heightMap = refTexture //'https://srmcgann.github.io/Coordinates/resources/bumpmap_equirectangular_po2.jpg'
      
      Coordinates.AnimationLoop(renderer, 'Draw')

      var shaderOptions = [
        { lighting: { type: 'ambientLight', value: .4}},
        { uniform: {
          type: 'phong',
          value: .45
        } },
        { uniform: {
          type: 'reflection',
          enabled: true,
          value: .3,
          map: refTexture,
          playbackSpeed: 1,
        } }
      ]
      var shader = await Coordinates.BasicShader(renderer, shaderOptions)

      var shaderOptions = [
        { lighting: {type: 'ambientLight', value: .5}},
        { uniform: {
          type: 'phong',
          value: 0
        } },
      ]
      var backgroundShader = await Coordinates.BasicShader(renderer, shaderOptions)

      var shapes = []

      const LoadAnimation = async (urlTemplate, frameno) => {
        var frames = Array(frameno).fill().map(v=>({shape:{}, loaded: false}))
        for(var i = 0; i< frameno; ++i){
          var ct = (''+(i+1)).padStart(4, '0')
          var geoOptions = {
            name: `frame${ct}`,
            shapeType: 'custom shape',
            //involveCache: false,
            url: `${urlTemplate}${ct}.json`,
            colorMix: 0,
            //exportShape: true,
          }
          await Coordinates.LoadGeometry(renderer, geoOptions).then(async (geometry) => {
            frames[i].shape = geometry
            frames[i].loaded = true
            await shader.ConnectGeometry(geometry)
          })
        }
        return { frames, frameno, curFrame: 0 }
      }

      const LoadAnimationFromZip = (url, name='', callback='') => {
        var ret = {loaded: false, frames: [],
                   curFrame: 0, name, geometries: []}
        fetch(url).then(res=>res.blob()).then(data => {
          ;(new zip.ZipReader(new zip.BlobReader(data))).getEntries().then(async res => {
            var tct = res.length
            ret.frames = Array(tct).fill().map(v=>({data: {}, name: ''}))
            await res.forEach(async (file, i) => {
              var data = JSON.parse(await (await file.getData(new zip.BlobWriter())).text())
              var ct = (''+(i+1)).padStart(4, '0')
              ret.frames[i].name = `frame${ct}`
              ret.frames[i].data = data
              if(i==tct-1) {
                ret.loaded = true
                if(callback) callback(ret)
              }
            })
          })
        })
        return ret
      }
      
      //var metaballAnimation = await LoadAnimation('./metaballs/frame', 1)
      var metaballAnimation = await LoadAnimationFromZip('https://srmcgann.github.io/Coordinates/custom shapes/alienDog/body/body.zip',
      'metaball animation', (resource) => {
        resource.frames.forEach((frame, idx) => {
          if(!(idx%4)){
            var geoOptions = {
              shapeType: 'custom shape',
              flipNormals: true,
              name: 'metaball animation frame',
              geometryData: frame.data,
              color: 0x884400,
              y: -4.5,
              //map: 'https://srmcgann.github.io/Coordinates/custom shapes/alienDog/textures/diffuse.jpg',
              //map: 'https://bosstools.mooo.com/assets/uploads/1QXQ2S.jpeg',
              map: heightMap,
              scaleUVX: 4,
              scaleUVY: 4,
              //heightMap,
              equirectangular: true,
              //heightMapIntensity: 2,
              colorMix: 0,
            }
            Coordinates.LoadGeometry(renderer, geoOptions).then(async (geometry) => {
              resource.geometries[idx/4|0] = geometry
              await shader.ConnectGeometry(geometry)
            })
          }
        })
      })
      
      
      var geoOptions = {
        shapeType: 'dodecahedron',
        name: 'background',
        subs: 2,
        size: 1e4,
        map: refTexture,
        colorMix: 0,
      }
      await Coordinates.LoadGeometry(renderer, geoOptions).then(async (geometry) => {
        shapes.push(geometry)
        await backgroundShader.ConnectGeometry(geometry)
      })  
      
      var geoOptions = {
        shapeType: 'cube',
        name: 'base',
        subs: 3,
        y: -25,
        equirectangular: false,
        averageNormals: true,
        spherize: .25,
        heightMap: refTexture,
        heightMapIntensity: 10,
        map: refTexture,
        size: 30,
        colorMix: 0,
      }
      await Coordinates.LoadGeometry(renderer, geoOptions).then(async (geometry) => {
        shapes.push(geometry)
        await shader.ConnectGeometry(geometry)
      })  
      
      // 60 = once per second. 30 = 2x per second. 0,1 = advance per frame (60fps).
      var animationSpeed = 2
      
      window.Draw = () => {
        var t = renderer.t
        
        if(typeof metaballAnimation != 'undefined' && metaballAnimation.loaded &&
           metaballAnimation.geometries.length){
          if(!(((t*60)|0)%animationSpeed)) metaballAnimation.curFrame++
          if(metaballAnimation.curFrame >= metaballAnimation.geometries.length){   
            metaballAnimation.curFrame = 0
          }
          if(metaballAnimation.curFrame < 0){
            metaballAnimation.curFrame = metaballAnimation.geometries.length - 1
          }
          var shape = metaballAnimation.geometries[metaballAnimation.curFrame]
          if(typeof shape != 'undefined' && shape.vertices.length){
            shape.yaw = -t / 2
            //shape.pitch += .005
            renderer.Draw(shape)
          }
        }
        
        renderer.yaw += .005
        renderer.pitch = C(t/2) / 2 + .5
        shapes.forEach(shape => {
          switch(shape.name){
            case 'background':
            break
            case 'base':
            shape.yaw = -t / 2
            break
            default:
              shape.yaw += .01
              shape.pitch += .005
            break
          }
          renderer.Draw(shape)
        })
      }
      
    </script>
  </body>
</html>